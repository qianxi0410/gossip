<!DOCTYPE html><html lang="zh-CN" id="html"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>qianxi0410<!-- -->&#x27;s website</title><meta name="next-head-count" content="3"/><link rel="shortcut icon" href="./favicon.ico"/><link rel="preload" href="/gossip/_next/static/css/dd8da961ffe278cb.css" as="style"/><link rel="stylesheet" href="/gossip/_next/static/css/dd8da961ffe278cb.css" data-n-g=""/><link rel="preload" href="/gossip/_next/static/css/e5f1874ce0400393.css" as="style"/><link rel="stylesheet" href="/gossip/_next/static/css/e5f1874ce0400393.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/gossip/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/gossip/_next/static/chunks/webpack-82d33c59ae4f941d.js" defer=""></script><script src="/gossip/_next/static/chunks/framework-281bd828f4ecdac7.js" defer=""></script><script src="/gossip/_next/static/chunks/main-824caf0e2a8c0bdd.js" defer=""></script><script src="/gossip/_next/static/chunks/pages/_app-00eb967a79124443.js" defer=""></script><script src="/gossip/_next/static/chunks/935-a866300cee426cf1.js" defer=""></script><script src="/gossip/_next/static/chunks/576-6d170c36519565ad.js" defer=""></script><script src="/gossip/_next/static/chunks/423-791032c4a81ff8b8.js" defer=""></script><script src="/gossip/_next/static/chunks/pages/post/%5Bid%5D-2ba027ed5b580137.js" defer=""></script><script src="/gossip/_next/static/Pbkwq2UBtcLSoMTZH9Dpl/_buildManifest.js" defer=""></script><script src="/gossip/_next/static/Pbkwq2UBtcLSoMTZH9Dpl/_ssgManifest.js" defer=""></script></head><body class="dark:bg-black bg-slate-50"><div id="__next"><script>!function(){try{var d=document.documentElement,n='data-theme',s='setAttribute';var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';d[s](n,'dark')}else{d.style.colorScheme = 'light';d[s](n,'light')}}else if(e){d[s](n,e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script><div class="flex flex-col h-screen container w-full md:w-3/4 xl:w-1/2"><header><div class="my-10 flex self-center flex-row justify-between"><div class="flex self-center flex-row justify-between"><a class="md:text-2xl text-xl cursor-pointer dark:hover:text-white dark:text-gray-400 text-gray-500 hover:text-black transition-colors duration-200 font-en" href="/gossip">cd ..</a></div><div class="self-center text-sm sm:text-lg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="2em" height="2em" viewBox="0 0 24 24" class="cursor-pointer"><path fill="currentColor" d="M12 5q-.425 0-.712-.288Q11 4.425 11 4V2q0-.425.288-.713Q11.575 1 12 1t.713.287Q13 1.575 13 2v2q0 .425-.287.712Q12.425 5 12 5Zm4.95 2.05q-.275-.275-.275-.688q0-.412.275-.712l1.4-1.425q.3-.3.712-.3q.413 0 .713.3q.275.275.275.7q0 .425-.275.7L18.35 7.05q-.275.275-.7.275q-.425 0-.7-.275ZM20 13q-.425 0-.712-.288Q19 12.425 19 12t.288-.713Q19.575 11 20 11h2q.425 0 .712.287q.288.288.288.713t-.288.712Q22.425 13 22 13Zm-8 10q-.425 0-.712-.288Q11 22.425 11 22v-2q0-.425.288-.712Q11.575 19 12 19t.713.288Q13 19.575 13 20v2q0 .425-.287.712Q12.425 23 12 23ZM5.65 7.05l-1.425-1.4q-.3-.3-.3-.725t.3-.7q.275-.275.7-.275q.425 0 .7.275L7.05 5.65q.275.275.275.7q0 .425-.275.7q-.3.275-.7.275q-.4 0-.7-.275Zm12.7 12.725l-1.4-1.425q-.275-.3-.275-.712q0-.413.275-.688q.275-.275.688-.275q.412 0 .712.275l1.425 1.4q.3.275.287.7q-.012.425-.287.725q-.3.3-.725.3t-.7-.3ZM2 13q-.425 0-.712-.288Q1 12.425 1 12t.288-.713Q1.575 11 2 11h2q.425 0 .713.287Q5 11.575 5 12t-.287.712Q4.425 13 4 13Zm2.225 6.775q-.275-.275-.275-.7q0-.425.275-.7L5.65 16.95q.275-.275.688-.275q.412 0 .712.275q.3.3.3.713q0 .412-.3.712l-1.4 1.4q-.3.3-.725.3t-.7-.3ZM12 18q-2.5 0-4.25-1.75T6 12q0-2.5 1.75-4.25T12 6q2.5 0 4.25 1.75T18 12q0 2.5-1.75 4.25T12 18Zm0-2q1.65 0 2.825-1.175Q16 13.65 16 12q0-1.65-1.175-2.825Q13.65 8 12 8q-1.65 0-2.825 1.175Q8 10.35 8 12q0 1.65 1.175 2.825Q10.35 16 12 16Z"></path></svg></div></div></header><main class="grow"><div><div class="flex flex-col mb-2"><div class="text-4xl sm:text-4xl font-medium dark:text-gray-200">docker-proxy</div><div class="sm:text-lg text-sm mt-2 dark:text-gray-400"><span>2022年8月27日</span> / <span>2022年9月25日</span></div></div><br/><div class="font-normal"><p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">最近在使用 docker 的时候，即便是配置了国内的镜像，也还是慢的可怕。
而且国内的镜像源并不能实时同步镜像的最新版本，所以还是选择了国外的源 + 代理的方式。</p>
<div class="mt-12 mb-6"><h2 class="sm:text-3xl text-2xl dark:text-white">pull-time proxy</h2><hr class="dark:border-dashed mt-1"/></div>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">拉取镜像的时候，是使用<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->dockerd<!-- -->`</code>守护进程。因此代理需要配置在<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->dockerd<!-- -->`</code>环境，而这个环境是<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->systemd<!-- -->`</code>负责，因此实际上是配置<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->systemd<!-- -->`</code>代理。</p>
<pre><div node="[object Object]" style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:1.8rem 0;overflow:auto;border-radius:0.5rem"><code class="font-en text-md" style="white-space:pre"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">1</span><span class="token" style="color:#DD4A68">sudo</span><span> </span><span class="token" style="color:#DD4A68">mkdir</span><span> -p /etc/systemd/system/docker.service.d
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">2</span><span></span><span class="token" style="color:#DD4A68">sudo</span><span> </span><span class="token" style="color:#DD4A68">touch</span><span> /etc/systemd/system/docker.service.d/proxy.conf</span></code></div></pre>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">添加下面的内容到<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->proxy.conf<!-- -->`</code>文件中：</p>
<pre><div node="[object Object]" style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:1.8rem 0;overflow:auto;border-radius:0.5rem"><code class="font-en text-md" style="white-space:pre"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">1</span><span>[Service]
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">2</span>Environment=&quot;HTTP_PROXY=http://ip:port/&quot;
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">3</span>Environment=&quot;HTTPS_PROXY=http://ip:port/&quot;
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">4</span>Environment=&quot;NO_PROXY=localhost,127.0.0.1&quot;</code></div></pre>
<blockquote node="[object Object]" class="border-l-4 pl-4 border-gray-300 dark:border-gray-600 rounded-l-sm italic my-4">
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">这里的 ip 是你的代理 ip 一般是 localhost，port 则是你代理转发的端口。</p>
</blockquote>
<div class="mt-12 mb-6"><h2 class="sm:text-3xl text-2xl dark:text-white">run-time proxy</h2><hr class="dark:border-dashed mt-1"/></div>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">运行容器的时候，如果你需要在容器内使用代理，则需要配置容器的代理。</p>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">这里有三种配置方法：</p>
<ol depth="0" node="[object Object]" class="sm:text-xl text-lg my-4 list-decimal pl-10 dark:text-gray-300">
<li class="ml-2 my-1">容器运行时指定</li>
</ol>
<pre><div node="[object Object]" style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:1.8rem 0;overflow:auto;border-radius:0.5rem"><code class="font-en text-md" style="white-space:pre"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">1</span><span class="token" style="color:#DD4A68">docker</span><span> run -e </span><span class="token assign-left" style="color:#e90">HTTP_PROXY</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span>http://ip:port/ -e </span><span class="token assign-left" style="color:#e90">HTTPS_PROXY</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span>http://ip:port/ -e </span><span class="token assign-left" style="color:#e90">NO_PROXY</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span>localhost </span><span class="token" style="color:#999">..</span><span>.</span></code></div></pre>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">这种方式的优点就是直接，但缺点就是每次启动容器都需要显示的设置。
为了解决这种情况，在 Docker 17.07 以上，可以使用配置 Docker 客户端的方式，即 2。</p>
<ol start="2" depth="0" node="[object Object]" class="sm:text-xl text-lg my-4 list-decimal pl-10 dark:text-gray-300">
<li class="ml-2 my-1">客户端全局配置</li>
</ol>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">在<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->~/.docker/config.json<!-- -->`</code>中，加入以下内容：</p>
<pre><div node="[object Object]" style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:1.8rem 0;overflow:auto;border-radius:0.5rem"><code class="font-en text-md" style="white-space:pre"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">1</span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">2</span><span>  </span><span class="token" style="color:#905">&quot;proxies&quot;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">3</span><span>    </span><span class="token" style="color:#905">&quot;default&quot;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">4</span><span>      </span><span class="token" style="color:#905">&quot;httpProxy&quot;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">&quot;http://ip:port&quot;</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">5</span><span>      </span><span class="token" style="color:#905">&quot;httpsProxy&quot;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">&quot;http://ip:port&quot;</span><span class="token" style="color:#999">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">6</span><span>      </span><span class="token" style="color:#905">&quot;noProxy&quot;</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">&quot;localhost,127.0.0.0/8&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">7</span><span>    </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">8</span><span>  </span><span class="token" style="color:#999">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">9</span><span></span><span class="token" style="color:#999">}</span></code></div></pre>
<ol start="3" depth="0" node="[object Object]" class="sm:text-xl text-lg my-4 list-decimal pl-10 dark:text-gray-300">
<li class="ml-2 my-1">host 网络模式</li>
</ol>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">如果你的容器使用的是 host 网络模式，那么容器内的网络就是宿主机的网络，因此可以直接使用宿主机的代理。</p>
<pre><div node="[object Object]" style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:1.8rem 0;overflow:auto;border-radius:0.5rem"><code class="font-en text-md" style="white-space:pre"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">1</span><span class="token" style="color:#DD4A68">docker</span><span> run --network </span><span class="token" style="color:#DD4A68">host</span><span> </span><span class="token" style="color:#999">..</span><span>.</span></code></div></pre>
<blockquote node="[object Object]" class="border-l-4 pl-4 border-gray-300 dark:border-gray-600 rounded-l-sm italic my-4">
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">上面的 ip 是 docker0 网卡的 ip，而不是容器内部的 ip。使用 ip addr show docker0 查看。</p>
</blockquote>
<div class="mt-12 mb-6"><h2 class="sm:text-3xl text-2xl dark:text-white">build-time proxy</h2><hr class="dark:border-dashed mt-1"/></div>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">容器构建的时候，本质上也是启动了一个容器。</p>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">这里没找到配置文件的方法，只能使用环境变量的方式，但是参数略有不同。</p>
<pre><div node="[object Object]" style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:1.8rem 0;overflow:auto;border-radius:0.5rem"><code class="font-en text-md" style="white-space:pre"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">1</span><span class="token" style="color:#DD4A68">docker</span><span> build </span><span class="token" style="color:#999">\</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">2</span><span>    --build-arg </span><span class="token" style="color:#690">&quot;HTTP_PROXY=http://ip:port/&quot;</span><span> </span><span class="token" style="color:#999">\</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">3</span><span>    --build-arg </span><span class="token" style="color:#690">&quot;HTTPS_PROXY=http://ip:port/&quot;</span><span> </span><span class="token" style="color:#999">\</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">4</span><span>    --build-arg </span><span class="token" style="color:#690">&quot;NO_PROXY=localhost,127.0.0.1&quot;</span><span> </span><span class="token" style="color:#999">\</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">5</span><span>    </span><span class="token" style="color:#999">..</span><span>.</span></code></div></pre>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">同样的，这里的 ip 也是<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->docker0<!-- -->`</code>网卡的 ip。</p>
<blockquote node="[object Object]" class="border-l-4 pl-4 border-gray-300 dark:border-gray-600 rounded-l-sm italic my-4">
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300">构建过程中，更推荐使用 host 网络模式，因为这样可以直接使用宿主机的代理。</p>
</blockquote>
<div class="mt-12 mb-6"><h2 class="sm:text-3xl text-2xl dark:text-white">重启生效</h2><hr class="dark:border-dashed mt-1"/></div>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300"><span node="[object Object]" class="bg-slate-50 text-slate-50 hover:text-black duration-500 dark:text-black dark:bg-black hover:dark:text-gray-200 hover:dark:bg-black cursor-pointer">重启计算机即可</span></p>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300"><code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->build-time<!-- -->`</code> 代理是在执行前设置的，所以修改后，下次执行立即生效。<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->run-time<!-- -->`</code> 代理的修改也是立即生效的，但是只针对以后启动的容器，对已经启动的容器无效。</p>
<p node="[object Object]" class="sm:text-xl text-lg mt-4 dark:text-gray-300"><code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->pull-time<!-- -->`</code>代理的修改比较特殊，它实际上是改<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->systemd<!-- -->`</code>的配置，因此需要重载<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->systemd<!-- -->`</code>并重启<code class="text-gray-600 dark:text-white" node="[object Object]">`<!-- -->dockerd<!-- -->`</code>才能生效。</p>
<pre><div node="[object Object]" style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:1.8rem 0;overflow:auto;border-radius:0.5rem"><code class="font-en text-md" style="white-space:pre"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">1</span><span class="token" style="color:#DD4A68">sudo</span><span> systemctl daemon-reload
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:slategray">2</span><span></span><span class="token" style="color:#DD4A68">sudo</span><span> systemctl restart </span><span class="token" style="color:#DD4A68">docker</span></code></div></pre></div><br/><div></div><a class="float-right mt-10 sm:text-2xl text-xl text-gray-500 hover:text-black transition-colors duration-200 dark:text-gray-400 dark:hover:text-gray-100" href="/gossip">cd ..</a></div></main><footer class="container mx-auto text-center text-gray-700 dark:text-gray-400"><div class="flex flex-row justify-center mb-5 space-x-5"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.8em" height="1.8em" viewBox="0 0 24 24" class="cursor-pointer"><path fill="currentColor" fill-rule="evenodd" d="M3.5 3.25a.75.75 0 0 1 .75-.75C14.053 2.5 22 10.447 22 20.25a.75.75 0 0 1-1.5 0C20.5 11.275 13.225 4 4.25 4a.75.75 0 0 1-.75-.75zM3.5 19a2 2 0 1 1 4 0a2 2 0 0 1-4 0zm.75-9.5a.75.75 0 0 0 0 1.5a9.25 9.25 0 0 1 9.25 9.25a.75.75 0 0 0 1.5 0C15 14.313 10.187 9.5 4.25 9.5z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.8em" height="1.8em" viewBox="0 0 24 24" class="cursor-pointer"><path fill="currentColor" d="M4 20q-.825 0-1.412-.587Q2 18.825 2 18V6q0-.825.588-1.412Q3.175 4 4 4h16q.825 0 1.413.588Q22 5.175 22 6v12q0 .825-.587 1.413Q20.825 20 20 20ZM20 8l-7.475 4.675q-.125.075-.263.112q-.137.038-.262.038t-.262-.038q-.138-.037-.263-.112L4 8v10h16Zm-8 3l8-5H4ZM4 8v.25v-1.475v.025V6v.8v-.013V8.25V8v10Z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.8em" height="1.8em" cursor="pointer" viewBox="0 0 16 16"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5.75 14.25s-.5-2 .5-3c0 0-2 0-3.5-1.5s-1-4.5 0-5.5c-.5-1.5.5-2.5.5-2.5s1.5 0 2.5 1c1-.5 3.5-.5 4.5 0c1-1 2.5-1 2.5-1s1 1 .5 2.5c1 1 1.5 4 0 5.5s-3.5 1.5-3.5 1.5c1 1 .5 3 .5 3m-5-.5c-1.5.5-3-.5-3.5-1"></path></svg></div><div class="mb-10 font-en">©<!-- -->2023<!-- -->. All rights reserved by <a href="https://github.com/qianxi0410" class="text-blue-500 hover:text-blue-900 transition-colors duration-300">qianxi0410</a>. Powered by <a href="https://github.com/qianxi0410/gossip" class="text-blue-500 hover:text-blue-900 transition-colors duration-300">Gossip</a>.</div></footer><div class="bottom-10 right-10 cursor-pointer fixed hidden lg:block"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1.8em" height="1.8em" viewBox="0 0 24 24" class="opacity-0 duration-700 transition-opacity ease-in-out"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19h14a2 2 0 0 0 1.84-2.75L13.74 4a2 2 0 0 0-3.5 0l-7.1 12.25A2 2 0 0 0 4.89 19"></path></svg></div><div id="sakana-widget" class="cursor-pointer bottom-0 left-16 fixed hidden xl:block"></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"id":35,"title":"docker-proxy","created_at":"2022-08-27T03:22:57Z","updated_at":"2022-09-25T01:40:18Z","content":"最近在使用 docker 的时候，即便是配置了国内的镜像，也还是慢的可怕。\r\n而且国内的镜像源并不能实时同步镜像的最新版本，所以还是选择了国外的源 + 代理的方式。\r\n\r\n## pull-time proxy\r\n\r\n拉取镜像的时候，是使用`dockerd`守护进程。因此代理需要配置在`dockerd`环境，而这个环境是`systemd`负责，因此实际上是配置`systemd`代理。\r\n\r\n```bash\r\nsudo mkdir -p /etc/systemd/system/docker.service.d\r\nsudo touch /etc/systemd/system/docker.service.d/proxy.conf\r\n```\r\n\r\n添加下面的内容到`proxy.conf`文件中：\r\n\r\n```txt\r\n[Service]\r\nEnvironment=\"HTTP_PROXY=http://ip:port/\"\r\nEnvironment=\"HTTPS_PROXY=http://ip:port/\"\r\nEnvironment=\"NO_PROXY=localhost,127.0.0.1\"\r\n```\r\n\r\n\u003e 这里的 ip 是你的代理 ip 一般是 localhost，port 则是你代理转发的端口。\r\n\r\n## run-time proxy\r\n\r\n运行容器的时候，如果你需要在容器内使用代理，则需要配置容器的代理。\r\n\r\n这里有三种配置方法：\r\n\r\n1. 容器运行时指定\r\n\r\n```bash\r\ndocker run -e HTTP_PROXY=http://ip:port/ -e HTTPS_PROXY=http://ip:port/ -e NO_PROXY=localhost ...\r\n```\r\n\r\n这种方式的优点就是直接，但缺点就是每次启动容器都需要显示的设置。\r\n为了解决这种情况，在 Docker 17.07 以上，可以使用配置 Docker 客户端的方式，即 2。\r\n\r\n2. 客户端全局配置\r\n\r\n在`~/.docker/config.json`中，加入以下内容：\r\n\r\n```json\r\n{\r\n  \"proxies\": {\r\n    \"default\": {\r\n      \"httpProxy\": \"http://ip:port\",\r\n      \"httpsProxy\": \"http://ip:port\",\r\n      \"noProxy\": \"localhost,127.0.0.0/8\"\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n3. host 网络模式\r\n\r\n如果你的容器使用的是 host 网络模式，那么容器内的网络就是宿主机的网络，因此可以直接使用宿主机的代理。\r\n\r\n```bash\r\ndocker run --network host ...\r\n```\r\n\r\n\u003e 上面的 ip 是 docker0 网卡的 ip，而不是容器内部的 ip。使用 ip addr show docker0 查看。\r\n\r\n## build-time proxy\r\n\r\n容器构建的时候，本质上也是启动了一个容器。\r\n\r\n这里没找到配置文件的方法，只能使用环境变量的方式，但是参数略有不同。\r\n\r\n```bash\r\ndocker build \\\r\n    --build-arg \"HTTP_PROXY=http://ip:port/\" \\\r\n    --build-arg \"HTTPS_PROXY=http://ip:port/\" \\\r\n    --build-arg \"NO_PROXY=localhost,127.0.0.1\" \\\r\n    ...\r\n```\r\n\r\n同样的，这里的 ip 也是`docker0`网卡的 ip。\r\n\r\n\u003e 构建过程中，更推荐使用 host 网络模式，因为这样可以直接使用宿主机的代理。\r\n\r\n## 重启生效\r\n\r\n~~重启计算机即可~~\r\n\r\n`build-time` 代理是在执行前设置的，所以修改后，下次执行立即生效。`run-time` 代理的修改也是立即生效的，但是只针对以后启动的容器，对已经启动的容器无效。\r\n\r\n`pull-time`代理的修改比较特殊，它实际上是改`systemd`的配置，因此需要重载`systemd`并重启`dockerd`才能生效。\r\n\r\n```bash\r\nsudo systemctl daemon-reload\r\nsudo systemctl restart docker\r\n```\r\n","author":"qianxi0410","reactions":{"url":"https://api.github.com/repos/qianxi0410/gossip/issues/35/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"labels":["published","docker","proxy"]}},"__N_SSG":true},"page":"/post/[id]","query":{"id":"docker-proxy"},"buildId":"Pbkwq2UBtcLSoMTZH9Dpl","assetPrefix":"/gossip","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>